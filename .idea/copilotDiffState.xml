<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/mdavila_2001/mappyapp/ui/viewmodels/RoutesViewModel.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/mdavila_2001/mappyapp/ui/viewmodels/RoutesViewModel.kt" />
              <option name="originalContent" value="package com.mdavila_2001.mappyapp.ui.viewmodels&#10;&#10;import android.app.Application&#10;import androidx.lifecycle.AndroidViewModel&#10;import androidx.lifecycle.viewModelScope&#10;import com.mdavila_2001.mappyapp.data.remote.models.Route&#10;import com.mdavila_2001.mappyapp.data.repositories.RouteRepository&#10;import com.mdavila_2001.mappyapp.utils.SessionManager&#10;import kotlinx.coroutines.flow.MutableStateFlow&#10;import kotlinx.coroutines.flow.SharingStarted&#10;import kotlinx.coroutines.flow.StateFlow&#10;import kotlinx.coroutines.flow.asStateFlow&#10;import kotlinx.coroutines.flow.map&#10;import kotlinx.coroutines.flow.stateIn&#10;import kotlinx.coroutines.flow.update&#10;import kotlinx.coroutines.launch&#10;&#10;enum class Tab {&#10;    ROUTES,&#10;    MY_ROUTES&#10;}&#10;&#10;data class RoutesUIState(&#10;    val isLoading: Boolean = true,&#10;    val selectedTab: Tab = Tab.ROUTES,&#10;    val list: List&lt;Route&gt; = emptyList(),&#10;    val searchText: String = &quot;&quot;,&#10;    val currentUsername: String = &quot;&quot;,&#10;)&#10;&#10;class RoutesViewModel(application: Application): AndroidViewModel(application) {&#10;    private val repository = RouteRepository()&#10;    private val sessionManager = SessionManager(application)&#10;&#10;    private val _uiState = MutableStateFlow(RoutesUIState())&#10;    val uiState: StateFlow&lt;RoutesUIState&gt; = _uiState.asStateFlow()&#10;&#10;    private val _toastMessage = MutableStateFlow&lt;String?&gt;(null)&#10;    val toastMessage: StateFlow&lt;String?&gt; = _toastMessage.asStateFlow()&#10;&#10;    private val _navigateToLogin = MutableStateFlow(false)&#10;    val navigateToLogin: StateFlow&lt;Boolean&gt; = _navigateToLogin.asStateFlow()&#10;&#10;    val filteredRoutes: StateFlow&lt;List&lt;Route&gt;&gt; = _uiState&#10;        .map { state -&gt;&#10;            if (state.searchText.isBlank()) {&#10;                state.list&#10;            } else {&#10;                state.list.filter { route -&gt;&#10;                    route.name.contains(state.searchText, ignoreCase = true) ||&#10;                            route.username.contains(state.searchText, ignoreCase = true)&#10;                }&#10;            }&#10;        }.stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), emptyList())&#10;&#10;    init {&#10;        val loggedInUser = sessionManager.getUserName() ?: &quot;&quot;&#10;        _uiState.update { it.copy(currentUsername = loggedInUser) }&#10;&#10;        loadRoutes()&#10;    }&#10;&#10;    private fun loadRoutes() {&#10;        viewModelScope.launch {&#10;            _uiState.update { it.copy(isLoading = true) }&#10;&#10;            val tab = _uiState.value.selectedTab&#10;            val routes = if (tab == Tab.ROUTES) {&#10;                repository.getAllRoutes()&#10;            } else {&#10;                repository.getRoutesByUser(uiState.value.currentUsername)&#10;            }&#10;            _uiState.update { it.copy(list = routes, isLoading = false) }&#10;        }&#10;    }&#10;&#10;    fun onTabSelected(tab: Tab) {&#10;        _uiState.update { it.copy(selectedTab = tab) }&#10;        loadRoutes()&#10;    }&#10;&#10;    fun onSearchTextChanged(text: String) {&#10;        _uiState.update { it.copy(searchText = text) }&#10;    }&#10;&#10;    fun deleteRoute(route: Route) {&#10;        viewModelScope.launch {&#10;            val success = repository.deleteRoute(route.id)&#10;            if(success) {&#10;                _uiState.update { currentState -&gt;&#10;                    currentState.copy(&#10;                        list = currentState.list.filterNot { it.id == route.id }&#10;                    )&#10;                }&#10;                // Recarga desde backend para asegurar consistencia y reflejar cambios de filtros&#10;                loadRoutes()&#10;                _toastMessage.value = &quot;Ruta eliminada correctamente&quot;&#10;            } else {&#10;                _toastMessage.value = &quot;Error al eliminar la ruta&quot;&#10;            }&#10;        }&#10;    }&#10;&#10;    fun clearToastMessage() {&#10;        _toastMessage.value = null&#10;    }&#10;&#10;    fun onNavigationDone() {&#10;        _navigateToLogin.value = false&#10;    }&#10;&#10;    fun onLogoutClicked() {&#10;        sessionManager.logout()&#10;        _navigateToLogin.value = true&#10;    }&#10;}" />
              <option name="updatedContent" value="package com.mdavila_2001.mappyapp.ui.viewmodels&#10;&#10;import android.app.Application&#10;import androidx.lifecycle.AndroidViewModel&#10;import androidx.lifecycle.viewModelScope&#10;import com.mdavila_2001.mappyapp.data.remote.models.Route&#10;import com.mdavila_2001.mappyapp.data.repositories.RouteRepository&#10;import com.mdavila_2001.mappyapp.utils.SessionManager&#10;import kotlinx.coroutines.flow.MutableStateFlow&#10;import kotlinx.coroutines.flow.SharingStarted&#10;import kotlinx.coroutines.flow.StateFlow&#10;import kotlinx.coroutines.flow.asStateFlow&#10;import kotlinx.coroutines.flow.map&#10;import kotlinx.coroutines.flow.stateIn&#10;import kotlinx.coroutines.flow.update&#10;import kotlinx.coroutines.launch&#10;&#10;enum class Tab {&#10;    ROUTES,&#10;    MY_ROUTES&#10;}&#10;&#10;data class RoutesUIState(&#10;    val isLoading: Boolean = true,&#10;    val selectedTab: Tab = Tab.ROUTES,&#10;    val list: List&lt;Route&gt; = emptyList(),&#10;    val searchText: String = &quot;&quot;,&#10;    val currentUsername: String = &quot;&quot;,&#10;)&#10;&#10;class RoutesViewModel(application: Application): AndroidViewModel(application) {&#10;    private val repository = RouteRepository()&#10;    private val sessionManager = SessionManager(application)&#10;&#10;    private val _uiState = MutableStateFlow(RoutesUIState())&#10;    val uiState: StateFlow&lt;RoutesUIState&gt; = _uiState.asStateFlow()&#10;&#10;    private val _toastMessage = MutableStateFlow&lt;String?&gt;(null)&#10;    val toastMessage: StateFlow&lt;String?&gt; = _toastMessage.asStateFlow()&#10;&#10;    private val _navigateToLogin = MutableStateFlow(false)&#10;    val navigateToLogin: StateFlow&lt;Boolean&gt; = _navigateToLogin.asStateFlow()&#10;&#10;    val filteredRoutes: StateFlow&lt;List&lt;Route&gt;&gt; = _uiState&#10;        .map { state -&gt;&#10;            if (state.searchText.isBlank()) {&#10;                state.list&#10;            } else {&#10;                state.list.filter { route -&gt;&#10;                    route.name.contains(state.searchText, ignoreCase = true) ||&#10;                            route.username.contains(state.searchText, ignoreCase = true)&#10;                }&#10;            }&#10;        }.stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), emptyList())&#10;&#10;    init {&#10;        val loggedInUser = sessionManager.getUserName() ?: &quot;&quot;&#10;        _uiState.update { it.copy(currentUsername = loggedInUser) }&#10;&#10;        loadRoutes()&#10;    }&#10;&#10;    private fun loadRoutes() {&#10;        viewModelScope.launch {&#10;            _uiState.update { it.copy(isLoading = true) }&#10;&#10;            val tab = _uiState.value.selectedTab&#10;            val routes = if (tab == Tab.ROUTES) {&#10;                repository.getAllRoutes()&#10;            } else {&#10;                repository.getRoutesByUser(uiState.value.currentUsername)&#10;            }&#10;            _uiState.update { it.copy(list = routes, isLoading = false) }&#10;        }&#10;    }&#10;&#10;    fun onTabSelected(tab: Tab) {&#10;        _uiState.update { it.copy(selectedTab = tab) }&#10;        loadRoutes()&#10;    }&#10;&#10;    fun onSearchTextChanged(text: String) {&#10;        _uiState.update { it.copy(searchText = text) }&#10;    }&#10;&#10;    fun deleteRoute(route: Route) {&#10;        viewModelScope.launch {&#10;            val success = repository.deleteRoute(route.id)&#10;            if(success) {&#10;                _uiState.update { currentState -&gt;&#10;                    currentState.copy(&#10;                        list = currentState.list.filterNot { it.id == route.id }&#10;                    )&#10;                }&#10;                // Recarga desde backend para asegurar consistencia y reflejar cambios de filtros&#10;                loadRoutes()&#10;                _toastMessage.value = &quot;Ruta eliminada correctamente&quot;&#10;            } else {&#10;                _toastMessage.value = &quot;Error al eliminar la ruta&quot;&#10;            }&#10;        }&#10;    }&#10;&#10;    fun clearToastMessage() {&#10;        _toastMessage.value = null&#10;    }&#10;&#10;    fun onNavigationDone() {&#10;        _navigateToLogin.value = false&#10;    }&#10;&#10;    fun onLogoutClicked() {&#10;        sessionManager.logout()&#10;        _navigateToLogin.value = true&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>